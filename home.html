{% extends "base.html" %}
{% block content %}

<div class="split">
  <aside class="left">
    <h2 class="headline">à la une</h2>
    <ul class="plist">
      {% for p in prologues %}
        <li class="pitem {{ 'active' if selected and selected['id']==p['id'] else '' }}">
          <a href="{{ url_for('index') }}?{% if current_category %}category={{current_category}}&{% endif %}p={{ p['id'] }}">
            <span class="dot">./</span>{{ p['title'] }}
          </a>
          {% if p['category_name'] %}<span class="chip">{{ p['category_name'] }}</span>{% endif %}
        </li>
      {% else %}
        <li>aucun prologue pour le moment</li>
      {% endfor %}
    </ul>

    {% if session.get('admin') %}
    <details class="compose">
      <summary>./ nouveau prologue</summary>
      <form method="post">
        <input name="title" placeholder="titre du prologue" required>
        <textarea name="content" placeholder="intro (optionnel)"></textarea>
        <select name="category_id">
          <option value="">— catégorie (optionnel) —</option>
          {% for c in nav_categories %}
            <option value="{{ c['id'] }}">{{ c['name'] }}</option>
          {% endfor %}
        </select>
        <button type="submit">publier</button>
      </form>
    </details>
    {% else %}
    <div class="hint muted">la création de prologues est réservée à la fondatrice</div>
    {% endif %}
  </aside>

  <section class="right">
    {% if selected %}
      <article class="prologue">
        <h1>{{ selected['title'] }}</h1>
        <div class="meta">
          {% if selected['category_name'] %}<span class="chip">{{ selected['category_name'] }}</span>{% endif %}
          <span class="date">{{ selected['created_at'][:16].replace('T',' ') }}</span>
        </div>
        {% if selected['content'] %}<p class="body">{{ selected['content'] }}</p>{% endif %}
      </article>

      <section class="replies">
        <h3>./ répliques</h3>
        <ul>
          {% for r in replies %}
            <li>
              <div class="meta">
                <span class="alias">{{ r['alias'] or 'anonyme' }}</span> — {{ r['created_at'][:16].replace('T',' ') }}
              </div>
              <p>{{ r['content'] }}</p>
            </li>
          {% else %}
            <li>pas encore de répliques</li>
          {% endfor %}
        </ul>

        <form method="post" action="{{ url_for('prologue', pid=selected['id']) }}" class="reply-form">
          <input name="alias" placeholder="votre pseudo (ex. quidian_lyon)" value="{{ request.cookies.get('alias','') }}">
          <textarea name="content" placeholder="écrire une réplique…" required></textarea>
          <button type="submit">répliquer</button>
        </form>
      </section>
    {% else %}
      <div class="placeholder">
        sélectionne un prologue à gauche pour afficher les répliques ici
      </div>
    {% endif %}
  </section>
</div>

{% endblock %}